@using PagedList.Mvc
@using System.Globalization;
@using System.Threading;
@model PagedList.IPagedList<CRIMAS.Models.Customer>



    @{
        ViewBag.Title = "Customer List";
        Layout = "~/Views/Shared/_CashierLayoutPageWithCommonTasks.cshtml";

        var db = new CRIMAS.Models.CrimasDb();
        var customers = Model.ToList();

        string search = Convert.ToString(ViewBag.Search);
        string sortBy = Convert.ToString(ViewBag.Sortby);
        string sortOrder = Convert.ToString(ViewBag.SortOrder);
        string tempSort = !string.IsNullOrEmpty(sortOrder) && sortOrder == "desc" ? "asc" : "desc";
        int curPage = Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber;

        //Set Culture info for currency
        CultureInfo cultureInfo = new CultureInfo("en-US");
        cultureInfo.NumberFormat.CurrencySymbol = "₦";

        Thread.CurrentThread.CurrentCulture = cultureInfo;
    }

    <div class="card customer-list" style="width:80%; margin-left:auto; margin-right:auto; margin-top:2em;">
        <div class="card-content">

            <div class="card-title" style="color:black">
                <span class="view-cistomer-header">Customers Enrolled - <b style="color:#0078d7">@db.Customers.Count()</b></span>
                <span class="view-customer-controls">
                    <a href="~/ExportData/ExportCustomerData" class="btn  btn-primary" style="float:right;" title="Export customer data to excel">
                        <img src="~/Images/Excel Online.png" />
                    </a>
                    <a href="~/Customer/Create" class="btn btn-primary" style="float:right;  margin-right:10px; margin-top:2px; font-size:10pt;">+ enroll new customer </a>
                </span>
            </div>

            <table class="table  bordered" >
                <tr style="font-size:9pt; border: 1px solid gray; background:whitesmoke; color:black;">
                    <td>
                        &nbsp;
                    </td>
                    <td>
                        <a style="color:gray; font-weight:bold;"  href="@Url.Action("Index", new { page = curPage, search, sortBy = "name", sortOrder = tempSort })">
                            Customer <i class="fa fa-sort-amount-asc" aria-hidden="true"></i>
                        </a>
                    </td>
                    <td>
                        <a  style="color:gray; font-weight:bold;"  href="@Url.Action("Index", new { page = curPage, search, sortBy = "account", sortOrder = tempSort })">
                            Account No. <i class="fa fa-sort-amount-asc" aria-hidden="true"></i>
                        </a>
                    </td>
                    <td  style="color:gray; font-weight:bold;">Employer</td>
                    <td  style="color:gray; font-weight:bold;">Savings Balance[NGN]</td>
                    @*<td>&nbsp;</td>*@
                </tr>

                @foreach (var item in customers)
                {
                    var credit = 0m;
                    var debit = 0m;
                    if (db.CustomerSavings.Count() != 0)
                    {
                        var customer = db.CustomerSavings.Where(x => x.AccountNo == @item.AccountNo);
                        if (customer != null)
                        {
                            credit = customer.Select(x => x.Credit).DefaultIfEmpty().Sum();
                            debit = customer.Select(x => x.Debit).DefaultIfEmpty().Sum();
                        }
                    }

                    var balance = credit - debit;

                    var imageUrl = string.IsNullOrEmpty(item.ImageUrl) ? "/images/user-48.png" : item.ImageUrl;

                    <tr style="text-transform:uppercase; background:#fafafa">
                        <td class="td-image">
                            @*<img src="@imageUrl" alt="No Image"/>*@

                            @{
                                if (item.image != null)
                                {
                                    <img i  src="~/Customer/RetrieveImage/@item.CustomerId" /> 
                                }
                                else
                                {
                                    <img  src="~/images/user-48.png" /> 
                                }

                            }
                        </td>
                        <td><a class="cust-name"  href="~/Customer/FindCustomer?searchString=@item.AccountNo">@item.Name</a></td>
                        <td><span class="account">@item.AccountNo</span></td>
                        <td>@item.OfficeAddress</td>
                        <td style="color:#0078d7; font-weight:bold">
                           @string.Format("{0:C}", @balance)
                        </td>
                        @*<td>
                            @if (User.IsInRole("Admin"))
                            {
                                <a title="remove this customer" href="~/Customer/Delete/@item.CustomerId" class="btn btn-floating  waves-effect waves-light" style="float:right; background:#b71c1c ;  margin-right:10px; margin-top:2px; font-size:10pt;">
                                    X
                                </a>
                            }
                            <a title="view customer account details" href="~/Customer/FindCustomer?searchString=@item.AccountNo" class="btn btn-floating  waves-effect waves-light" style="float:right;  margin-right:10px; margin-top:2px; font-size:10pt;">
                                <img style="margin-top:2px;" src="~/Images/View Medium icons-WF.png" />
                            </a>
                        </td>*@
                    </tr>
                }
            </table>
            <hr />
            <div style="text-align:center;">
                Page @curPage of @Model.PageCount
                @Html.PagedListPager(Model, page => Url.Action("Index", new { page, search, sortBy, sortOrder }))
            </div>
        </div>
    </div>
    <style>
        .table th a {
            color: #fff;
        }

        .td-image {
            padding: 4px;
        }

            .td-image img {
                border: 1px solid #ccc;
                border-radius: 25px;
                height: 50px;
                width: 50px;
                background-color:#eeeeee ;
            }
    </style>

<script>
    $(document).ready(function () {
        $(".td-image img").each(function () {
            $(this).error(function () {
                $(this).attr('src', '/images/user-48.png');
            });
        })
    });
</script> 